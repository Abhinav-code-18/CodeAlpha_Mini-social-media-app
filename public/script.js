const API='/api';let currentUser=null;
async function loadUsers(){const res=await fetch(API+'/users');const users=await res.json();const sel=document.getElementById('user');users.forEach(u=>{const o=document.createElement('option');o.value=u._id;o.textContent=u.display_name;sel.appendChild(o)});if(users.length){currentUser=users[0]._id;sel.value=currentUser;}sel.addEventListener('change',e=>{currentUser=e.target.value;loadFeed();});}
async function loadFeed(){const r=await fetch(API+'/posts');const posts=await r.json();const f=document.getElementById('feed');f.innerHTML='';posts.forEach(p=>{const c=document.createElement('div');c.className='post-card';c.innerHTML=`<div class='post-header'>${p.display_name} (@${p.username})</div><div class='post-content'>${p.content}</div><button class='like-btn' data-id='${p._id}'>‚ù§Ô∏è ${p.like_count}</button><button class='comment-btn' data-id='${p._id}'>üí¨ ${p.comment_count}</button><div class='comment-section' id='comments-${p._id}' style='display:none'></div>`;f.appendChild(c);});document.querySelectorAll('.like-btn').forEach(b=>b.addEventListener('click',()=>toggleLike(b.dataset.id)));document.querySelectorAll('.comment-btn').forEach(b=>b.addEventListener('click',()=>toggleComments(b.dataset.id)));}
async function toggleLike(id){await fetch(API+'/like',{method:'POST',headers:{'Content-Type':'application/json','X-User-Id':currentUser},body:JSON.stringify({target_type:'post',target_id:id})});loadFeed();}
async function toggleComments(id){const s=document.getElementById('comments-'+id);if(s.style.display==='none'){const r=await fetch(API+'/posts/'+id+'/comments');const cs=await r.json();s.innerHTML='';cs.forEach(c=>{const d=document.createElement('div');d.className='comment';d.textContent=`${c.display_name}: ${c.content}`;s.appendChild(d);});const i=document.createElement('input');i.placeholder='Write a comment...';i.style.width='80%';const b=document.createElement('button');b.textContent='Post';b.onclick=async()=>{await fetch(API+'/posts/'+id+'/comments',{method:'POST',headers:{'Content-Type':'application/json','X-User-Id':currentUser},body:JSON.stringify({content:i.value})});toggleComments(id);};s.appendChild(i);s.appendChild(b);s.style.display='block';}else{s.style.display='none';}}
document.getElementById('postBtn').addEventListener('click',async()=>{const c=document.getElementById('postContent').value.trim();if(!c)return;await fetch(API+'/posts',{method:'POST',headers:{'Content-Type':'application/json','X-User-Id':currentUser},body:JSON.stringify({content:c})});document.getElementById('postContent').value='';loadFeed();});loadUsers().then(loadFeed);
